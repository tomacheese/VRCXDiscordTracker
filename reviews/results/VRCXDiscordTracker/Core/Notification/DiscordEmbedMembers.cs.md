# ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

## ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
- **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: VRCXDiscordTracker/Core/Notification/DiscordEmbedMembers.cs
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥æ™‚**: 2025-06-06
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: 431è¡Œï¼ˆå¤§è¦æ¨¡ï¼‰

## æ¦‚è¦
VRChatã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’Discord Embedå½¢å¼ã«å¤‰æ›ã™ã‚‹è¤‡é›‘ãªã‚¯ãƒ©ã‚¹ã€‚ã‚µã‚¤ã‚ºåˆ¶é™ã«å¿œã˜ãŸå‹•çš„ãªè¡¨ç¤ºèª¿æ•´æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚

## ç·åˆè©•ä¾¡
**ã‚¹ã‚³ã‚¢: 6/10**

é«˜åº¦ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ãŒã€è¤‡é›‘æ€§ã€å¯èª­æ€§ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¦³ç‚¹ã§æ”¹å–„ãŒå¿…è¦ã€‚

## è©³ç´°è©•ä¾¡

### 1. è¨­è¨ˆãƒ»æ§‹é€ ã®è©•ä¾¡ â­â­â­â˜†â˜†
**Good:**
- å‹•çš„ãªã‚µã‚¤ã‚ºèª¿æ•´æ©Ÿèƒ½
- æ®µéšçš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
- é©åˆ‡ãªè²¬ä»»åˆ†é›¢

**Issues:**
- éåº¦ã«è¤‡é›‘ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- é•·ã„ãƒ¡ã‚½ãƒƒãƒ‰
- å¤šæ•°ã®æ¡ä»¶åˆ†å²

### 2. ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®éµå®ˆçŠ¶æ³ â­â­â­â­â˜†
**Good:**
- C#å‘½åè¦ç´„ã«æº–æ‹ 
- XMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå……å®Ÿ
- ãƒ¢ãƒ€ãƒ³ãªC#æ§‹æ–‡ã®ä½¿ç”¨

**Issues:**
- ãƒ¡ã‚½ãƒƒãƒ‰ã®é•·ã•
- è¤‡é›‘ãªæ¡ä»¶å¼

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ â­â­â­â­â˜†
**Good:**
- é©åˆ‡ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
- å…¥åŠ›æ¤œè¨¼

**Minor Issues:**
- URLç”Ÿæˆæ™‚ã®æ¤œè¨¼ä¸è¶³

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œ â­â­â­â˜†â˜†
**Good:**
- åŠ¹ç‡çš„ãªæ–‡å­—åˆ—å‡¦ç†
- é©åˆ‡ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨

**Issues:**
- ç¹°ã‚Šè¿”ã—å‡¦ç†ã§ã®ValidateEmbedå‘¼ã³å‡ºã—
- æ–‡å­—åˆ—ã®é‡è¤‡æ“ä½œ

### 5. å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ â­â­â˜†â˜†â˜†
**Issues:**
- æ¥µã‚ã¦è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯
- é•·ã„æ¡ä»¶åˆ†å²
- ãƒ‡ãƒãƒƒã‚°ç”¨Console.WriteLineã®å¤šç”¨

### 6. ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ â­â­â˜†â˜†â˜†
**Issues:**
- è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ†ã‚¹ãƒˆå›°é›£
- å¤–éƒ¨ä¾å­˜ï¼ˆDiscord.NETï¼‰
- å‰¯ä½œç”¨ã®å¤šã„å‡¦ç†

## å…·ä½“çš„ãªå•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆ

### 1. ã€é‡è¦åº¦ï¼šé«˜ã€‘ã‚¯ãƒ©ã‚¹åˆ†å‰²ã¨è²¬ä»»ã®æ˜ç¢ºåŒ–
**å•é¡Œ**: å˜ä¸€ã‚¯ãƒ©ã‚¹ã«è¤‡é›‘ãªå‡¦ç†ãŒé›†ä¸­

**æ”¹å–„æ¡ˆ**:
```csharp
/// <summary>
/// Discord Embedæ§‹ç¯‰ã®è²¬ä»»ã‚’åˆ†é›¢
/// </summary>
internal class DiscordEmbedBuilder
{
    private readonly IEmbedSizeCalculator _sizeCalculator;
    private readonly IEmbedFieldGenerator _fieldGenerator;
    private readonly IEmbedContentFormatter _contentFormatter;

    public DiscordEmbedBuilder(
        IEmbedSizeCalculator sizeCalculator,
        IEmbedFieldGenerator fieldGenerator,
        IEmbedContentFormatter contentFormatter)
    {
        _sizeCalculator = sizeCalculator;
        _fieldGenerator = fieldGenerator;
        _contentFormatter = contentFormatter;
    }

    public Embed BuildEmbed(MyLocation location, List<InstanceMember> members)
    {
        var baseEmbed = CreateBaseEmbed(location, members);
        var fields = _fieldGenerator.GenerateFields(members);
        var optimizedFields = _sizeCalculator.OptimizeFields(baseEmbed, fields);
        
        return baseEmbed.WithFields(optimizedFields).Build();
    }
}

/// <summary>
/// Embedã‚µã‚¤ã‚ºè¨ˆç®—ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ€é©åŒ–
/// </summary>
internal class EmbedSizeCalculator : IEmbedSizeCalculator
{
    private readonly List<IFieldOptimizationStrategy> _strategies;

    public EmbedSizeCalculator()
    {
        _strategies = [
            new FullFormatStrategy(),
            new ExcludeLinksStrategy(),
            new NameOnlyStrategy(),
            new FieldReductionStrategy()
        ];
    }

    public List<EmbedFieldBuilder> OptimizeFields(EmbedBuilder baseEmbed, List<EmbedFieldBuilder> fields)
    {
        foreach (var strategy in _strategies)
        {
            var optimizedFields = strategy.Optimize(baseEmbed, fields);
            if (IsValidEmbed(baseEmbed.WithFields(optimizedFields)))
            {
                return optimizedFields;
            }
        }
        
        throw new EmbedOptimizationException("Unable to fit content within Discord limits");
    }
}

/// <summary>
/// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ€é©åŒ–æˆ¦ç•¥ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
/// </summary>
internal interface IFieldOptimizationStrategy
{
    List<EmbedFieldBuilder> Optimize(EmbedBuilder baseEmbed, List<EmbedFieldBuilder> fields);
    int Priority { get; }
}

/// <summary>
/// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°å‰Šæ¸›æˆ¦ç•¥
/// </summary>
internal class FieldReductionStrategy : IFieldOptimizationStrategy
{
    public int Priority => 100;

    public List<EmbedFieldBuilder> Optimize(EmbedBuilder baseEmbed, List<EmbedFieldBuilder> fields)
    {
        if (fields.Count <= 25) return fields;

        var reducedFields = fields.Take(25).ToList();
        
        // æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« "... and X more" ã‚’è¿½åŠ 
        var omittedCount = fields.Count - 25;
        if (reducedFields.Any())
        {
            var lastField = reducedFields.Last();
            lastField.Value += $"\n... and {omittedCount} more";
        }

        return reducedFields;
    }
}
```

### 2. ã€é‡è¦åº¦ï¼šé«˜ã€‘ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
**å•é¡Œ**: ä¾‹å¤–å‡¦ç†ãŒä¸å®Œå…¨ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‹æœªä½¿ç”¨

**æ”¹å–„æ¡ˆ**:
```csharp
/// <summary>
/// Embedæ§‹ç¯‰å°‚ç”¨ã®ä¾‹å¤–ã‚¯ãƒ©ã‚¹
/// </summary>
public class EmbedBuildException : Exception
{
    public EmbedBuildException(string message) : base(message) { }
    public EmbedBuildException(string message, Exception innerException) : base(message, innerException) { }
}

public class EmbedOptimizationException : EmbedBuildException
{
    public int AttemptedFieldCount { get; }
    public int ContentLength { get; }

    public EmbedOptimizationException(string message, int fieldCount, int contentLength) : base(message)
    {
        AttemptedFieldCount = fieldCount;
        ContentLength = contentLength;
    }
}

/// <summary>
/// å …ç‰¢ãªEmbedæ§‹ç¯‰
/// </summary>
public Embed BuildEmbedSafely(MyLocation location, List<InstanceMember> members)
{
    try
    {
        ValidateInputs(location, members);
        return BuildEmbed(location, members);
    }
    catch (FormatException ex)
    {
        throw new EmbedBuildException($"Invalid location format: {ex.Message}", ex);
    }
    catch (ArgumentException ex)
    {
        throw new EmbedBuildException($"Invalid member data: {ex.Message}", ex);
    }
    catch (Exception ex)
    {
        throw new EmbedBuildException($"Unexpected error building embed: {ex.Message}", ex);
    }
}

private void ValidateInputs(MyLocation location, List<InstanceMember> members)
{
    ArgumentNullException.ThrowIfNull(location, nameof(location));
    ArgumentNullException.ThrowIfNull(members, nameof(members));

    if (string.IsNullOrWhiteSpace(location.WorldName))
        throw new ArgumentException("World name cannot be empty", nameof(location));

    if (string.IsNullOrWhiteSpace(location.LocationId))
        throw new ArgumentException("Location ID cannot be empty", nameof(location));

    if (!location.LocationId.Contains(':'))
        throw new FormatException("Location ID must contain a colon separator");
}
```

### 3. ã€é‡è¦åº¦ï¼šä¸­ã€‘ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–
**æ”¹å–„æ¡ˆ**:
```csharp
/// <summary>
/// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ä»˜ãã®Embedæ§‹ç¯‰
/// </summary>
internal class CachedEmbedBuilder : IEmbedBuilder
{
    private readonly IEmbedBuilder _innerBuilder;
    private readonly IMemoryCache _cache;
    private readonly TimeSpan _cacheExpiry = TimeSpan.FromMinutes(1);

    public CachedEmbedBuilder(IEmbedBuilder innerBuilder, IMemoryCache cache)
    {
        _innerBuilder = innerBuilder;
        _cache = cache;
    }

    public Embed BuildEmbed(MyLocation location, List<InstanceMember> members)
    {
        var cacheKey = GenerateCacheKey(location, members);
        
        if (_cache.TryGetValue(cacheKey, out Embed cachedEmbed))
        {
            return UpdateTimestamp(cachedEmbed);
        }

        var embed = _innerBuilder.BuildEmbed(location, members);
        _cache.Set(cacheKey, embed, _cacheExpiry);
        return embed;
    }

    private string GenerateCacheKey(MyLocation location, List<InstanceMember> members)
    {
        var memberHash = string.Join(",", members
            .OrderBy(m => m.UserId)
            .Select(m => $"{m.UserId}:{m.IsCurrently}:{m.LastJoinAt?.Ticks}:{m.LastLeaveAt?.Ticks}"));
        
        return $"{location.JoinId}:{location.LocationId}:{memberHash.GetHashCode()}";
    }
}

/// <summary>
/// åŠ¹ç‡çš„ãªæ–‡å­—åˆ—æ“ä½œ
/// </summary>
internal class EfficientStringBuilder
{
    private readonly StringBuilder _builder = new();

    public EfficientStringBuilder AppendMemberLine(InstanceMember member, MemberTextFormat format)
    {
        var emoji = GetMemberEmoji(member);
        var name = $"`{SanitizeForDiscord(member.DisplayName)}`";

        _builder.Append(emoji).Append(' ');

        switch (format)
        {
            case MemberTextFormat.Full:
                _builder.Append('[').Append(name).Append("](")
                        .Append("https://vrchat.com/home/user/").Append(member.UserId)
                        .Append("): ");
                AppendJoinLeaveTime(member);
                break;
            case MemberTextFormat.ExcludeLinks:
                _builder.Append(name).Append(": ");
                AppendJoinLeaveTime(member);
                break;
            case MemberTextFormat.NameOnly:
                _builder.Append(name);
                break;
        }

        return this;
    }

    public string Build() => _builder.ToString();
}
```

### 4. ã€é‡è¦åº¦ï¼šä¸­ã€‘ãƒ­ã‚°æ©Ÿèƒ½ã®æ”¹å–„
**æ”¹å–„æ¡ˆ**:
```csharp
/// <summary>
/// æ§‹é€ åŒ–ãƒ­ã‚°å¯¾å¿œ
/// </summary>
internal class EmbedBuildLogger
{
    private readonly ILogger<DiscordEmbedMembers> _logger;

    public EmbedBuildLogger(ILogger<DiscordEmbedMembers> logger)
    {
        _logger = logger;
    }

    public void LogEmbedBuildStart(int memberCount)
    {
        _logger.LogInformation("Starting embed build for {MemberCount} members", memberCount);
    }

    public void LogOptimizationAttempt(string strategyName, int fieldCount, int contentLength)
    {
        _logger.LogDebug("Trying optimization strategy {Strategy} with {FieldCount} fields, {ContentLength} chars",
            strategyName, fieldCount, contentLength);
    }

    public void LogOptimizationSuccess(string strategyName)
    {
        _logger.LogInformation("Embed optimization succeeded with strategy {Strategy}", strategyName);
    }

    public void LogOptimizationFailure(string error)
    {
        _logger.LogWarning("Embed optimization failed: {Error}", error);
    }
}
```

### 5. ã€é‡è¦åº¦ï¼šä½ã€‘è¨­å®šã®å¤–éƒ¨åŒ–
**æ”¹å–„æ¡ˆ**:
```csharp
/// <summary>
/// Embedæ§‹ç¯‰è¨­å®š
/// </summary>
public class EmbedBuildSettings
{
    public int MaxFieldCount { get; set; } = 25;
    public int MaxFieldValueLength { get; set; } = 1024;
    public int MaxEmbedLength { get; set; } = 6000;
    public bool EnableFieldReduction { get; set; } = true;
    public bool EnableContentTruncation { get; set; } = true;
    public string TruncationSuffix { get; set; } = "...";
    public TimeSpan CacheExpiry { get; set; } = TimeSpan.FromMinutes(1);
}

/// <summary>
/// çµµæ–‡å­—è¨­å®š
/// </summary>
public class EmojiSettings
{
    public string InstanceOwner { get; set; } = "ğŸ‘‘";
    public string Self { get; set; } = "ğŸ‘¤";
    public string Friend { get; set; } = "â­ï¸";
    public string Other { get; set; } = "â¬œï¸";
}
```

## æ¨å¥¨ã•ã‚Œã‚‹Next Steps
1. ã‚¯ãƒ©ã‚¹åˆ†å‰²ã¨è²¬ä»»ã®æ˜ç¢ºåŒ–ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
3. ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ã®é©åˆ‡ãªå®Ÿè£…ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
5. åŒ…æ‹¬çš„ãªå˜ä½“ãƒ†ã‚¹ãƒˆã®è¿½åŠ ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰

## ã‚³ãƒ¡ãƒ³ãƒˆ
é«˜åº¦ã§è¤‡é›‘ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€Discord APIã®åˆ¶é™ã«å¯¾ã™ã‚‹å¯¾å¿œã¯è©•ä¾¡ã§ãã¾ã™ã€‚ã—ã‹ã—ã€430è¡Œã‚’è¶…ãˆã‚‹å·¨å¤§ãªã‚¯ãƒ©ã‚¹ã¯ä¿å®ˆæ€§ã«æ·±åˆ»ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«`GetEmbed`ãƒ¡ã‚½ãƒƒãƒ‰ã®è¤‡é›‘ã•ã¨ãƒ‡ãƒãƒƒã‚°ç”¨Console.WriteLineã®å¤šç”¨ã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ä¸é©åˆ‡ã§ã™ã€‚ã‚¯ãƒ©ã‚¹åˆ†å‰²ã¨é©åˆ‡ãªãƒ­ã‚°æ©Ÿèƒ½ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ã‚ˆã‚Šä¿å®ˆã—ã‚„ã™ã„è¨­è¨ˆã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚